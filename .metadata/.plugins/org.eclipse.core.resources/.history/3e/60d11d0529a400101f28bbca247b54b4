@echo off
setlocal ENABLEEXTENSIONS

rem --- 1. Define folder variables ====
set "RES=target\allure-results"
set "REP=target\allure-report"

echo Running Maven tests...
rem --- 2. Run the Maven tests ====
call mvn -q test
if errorlevel 1 (
    echo Tests failed ^(Maven build failure^). Still generating report for debugging...
)

rem --- 3. Copy history from the previous report (for the trends chart) ====
if exist "%REP%\history" (
    echo Copying history from previous report to new results...
    xcopy /E /I /Y "%REP%\history" "%RES%\history" >nul
)

echo Generating Allure report...
rem --- 4. Generate the new Allure report ====
allure generate "%RES%" -o "%REP%" --clean >nul

echo.
echo Report successfully generated! Opening in default browser...

rem --- 5. Open the report in the browser (guaranteed method) ====
rem We use the "start" command to open the index.html file directly.
start "" "%REP%\index.html"

echo.
echo Script finished.

endlocal