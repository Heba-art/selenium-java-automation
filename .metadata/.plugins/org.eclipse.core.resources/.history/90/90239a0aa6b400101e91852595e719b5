package com.mycompany.selenium_automation_project.tests;

import java.time.Duration;

import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;
import org.testng.Assert;
import org.testng.annotations.Test;

import com.mycompany.selenium_automation_project.CartPage;
import com.mycompany.selenium_automation_project.CheckoutPage;
import com.mycompany.selenium_automation_project.LoginPage;
import com.mycompany.selenium_automation_project.ProductsPage;
import com.mycompany.selenium_automation_project.base.BaseTest;

import io.qameta.allure.Description;
import io.qameta.allure.Epic;
import io.qameta.allure.Feature;
import io.qameta.allure.Owner;
import io.qameta.allure.Severity;
import io.qameta.allure.SeverityLevel;
import io.qameta.allure.Story;

public class SauceDemoCheckoutTest extends BaseTest{

	@Epic("SauceDemo Automation")
	@Feature("Checkout")
	@Story("Complete checkout process successfully")
	@Severity(SeverityLevel.CRITICAL)
	@Owner("Heba AL-Rubaye")
	@Description("Verify that a user can complete the full checkout process from cart to the 'Checkout: Complete!' page.")
	@Test(priority = 6)
	
	public void TC_SD_006_completeCheckoutFlow() {
	    final String product = "Sauce Labs Backpack";

	    // Login
	    LoginPage login = new LoginPage(driver);
	    login.open(baseUrl);
	    login.login("standard_user", "secret_sauce");

	    // Add product
	    ProductsPage products = new ProductsPage(driver);
	    products.waitUntilLoaded();
	    products.addProductToCart(product);

	    // Go to cart
	    CartPage cart = products.openCart();
	    Assert.assertTrue(cart.isProductInCart(product), "Item should be in cart before checkout");

	    // >>> هذا هو المفتاح: انقري زر Checkout من صفحة السلة
	    CheckoutPage checkout = cart.clickCheckout();

	    // Step One: أدخلي البيانات واضغطي Continue (حسب طريقتك الحالية)
	    checkout.fillInfo("Heba", "QA", "3000");
	    checkout.clickContinue();
	    // Step Two: انتظري صفحة الملخّص
	    new WebDriverWait(driver, Duration.ofSeconds(20))
	            .until(ExpectedConditions.or(
	                    ExpectedConditions.urlContains("/checkout-step-two.html"),
	                    ExpectedConditions.visibilityOfElementLocated(By.cssSelector(".summary_info"))
	            ));

	    // Finish
	    By finishBtn = By.cssSelector("[data-test='finish']");
	    clickWithRetry(finishBtn);
	    new WebDriverWait(driver, Duration.ofSeconds(20))
	            .until(ExpectedConditions.or(
	                    ExpectedConditions.urlContains("/checkout-complete.html"),
	                    ExpectedConditions.visibilityOfElementLocated(By.cssSelector(".complete-header"))
	            ));

	    // Verify
	    WebElement header = new WebDriverWait(driver, Duration.ofSeconds(10))
	            .until(ExpectedConditions.visibilityOfElementLocated(By.cssSelector(".complete-header")));
	    Assert.assertEquals(header.getText(), "Thank you for your order!", "Success message mismatch");
	}

}