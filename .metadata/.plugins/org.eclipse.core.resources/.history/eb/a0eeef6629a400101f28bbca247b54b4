@echo off
setlocal ENABLEEXTENSIONS

rem --- 1. Define folder variables ====
set "RES=target\allure-results"
set "REP=target\allure-report"

echo STEP 1: Running Maven tests...
rem --- 2. Run the Maven tests ====
call mvn -q test
if errorlevel 1 (
    echo WARNING: Tests failed ^(Maven build failure^). Still trying to generate report...
)
echo STEP 1: Finished Maven tests.

rem --- 3. Copy history from the previous report ====
if exist "%REP%\history" (
    echo STEP 2: Copying history...
    xcopy /E /I /Y "%REP%\history" "%RES%\history" >nul
    echo STEP 2: Finished copying history.
) else (
    echo INFO: No previous history found to copy.
)

echo STEP 3: Generating Allure report. This may take a moment...
rem --- 4. Generate the new Allure report (REMOVED >nul to show potential errors) ====
allure generate "%RES%" -o "%REP%" --clean

echo STEP 3: Finished generating Allure report.

echo STEP 4: Attempting to open the report...
rem --- 5. Open the report in the browser ====
start "" "%REP%\index.html"

echo.
echo ========================================================
echo Script finished. Press any key to close this window.
echo ========================================================
pause

endlocal